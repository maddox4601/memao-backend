name: Deploy Flask Backend (Master)

on:
  push:
    branches:
      - master  # æ˜ç¡®ä½¿ç”¨masteråˆ†æ”¯

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: master  # æ˜ç¡®æ£€å‡ºmasteråˆ†æ”¯

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: Verify SSH Connection
      run: |
        ssh -T -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} exit
        if [ $? -ne 0 ]; then
          echo "::error::SSHè¿æ¥æµ‹è¯•å¤±è´¥"
          exit 1
        fi

    - name: Deploy via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
        set -e
        echo "â–¶ï¸ [Master] å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
        
        # éªŒè¯éƒ¨ç½²ç›®å½•
        DEPLOY_DIR="/root/memao-backend"
        if [ ! -d "$DEPLOY_DIR" ]; then
          echo "::error::éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: $DEPLOY_DIR"
          exit 1
        fi

        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd "$DEPLOY_DIR" || exit 1
        
        # æ‹‰å–æœ€æ–°ä»£ç 
        echo "ğŸ”„ åŒæ­¥masteråˆ†æ”¯..."
        git fetch origin master
        git checkout master
        git reset --hard origin/master || {
          echo "::error::GitåŒæ­¥å¤±è´¥"
          exit 1
        }

        # æ£€æŸ¥æ–‡ä»¶å˜åŒ–
        echo "ğŸ“„ æ–‡ä»¶å˜æ›´æ£€æŸ¥:"
        git diff --name-only HEAD@{1} HEAD

        # é‡å»ºå®¹å™¨
        echo "ğŸ³ é‡å»ºDockeræœåŠ¡..."
        docker compose down --timeout 30 || true
        
        if ! docker compose up -d --build; then
          echo "::error::Dockeréƒ¨ç½²å¤±è´¥"
          docker logs memao-backend-backend-1 2>&1 | tail -n 50
          exit 1
        fi

        # å¥åº·æ£€æŸ¥
        echo "ğŸ©º æœåŠ¡å¥åº·æ£€æŸ¥..."
        sleep 10
        if ! docker ps --filter "name=memao-backend" --format "table {{.Names}}\t{{.Status}}" | grep "(healthy)"; then
          echo "::warning::å®¹å™¨æœªæ˜¾ç¤ºhealthyçŠ¶æ€"
          docker compose logs --tail=50
        fi

        echo "âœ… [Master] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
        EOF