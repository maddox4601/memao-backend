name: Deploy Flask Backend (Master)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 25
    env:
      FLASK_APP: "app.py"
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: master
        fetch-depth: 0

    - name: Validate Migrations
      run: |
        if [ -n "$(git status -s alembic/versions/)" ]; then
          echo "::error::Uncommitted migration files detected:"
          git status alembic/versions/
          exit 1
        fi

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: Deploy via SSH
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      run: |
        # Ê£ÄÊü•Êú¨Âú∞ secret ÊòØÂê¶ÂèØÁî®
        if [ -z "$GOOGLE_CLIENT_ID" ]; then
          echo "::error::GOOGLE_CLIENT_ID is empty"
        else
          echo "‚úÖ GOOGLE_CLIENT_ID is set (masked)"
        fi
        if [ -z "$GOOGLE_CLIENT_SECRET" ]; then
          echo "::error::GOOGLE_CLIENT_SECRET is empty"
        else
          echo "‚úÖ GOOGLE_CLIENT_SECRET is set (masked)"
        fi
        

    - name: Health check & Docker cleanup
      run: |
        echo "üíö ÂÅ•Â∫∑Ê£ÄÊü•..."
        for i in {1..10}; do
          STATUS=$(ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "curl -sf -w '%{http_code}' -o /dev/null http://localhost:5000/health || echo '000'")
          if [ "$STATUS" == "200" ]; then
            echo "‚úÖ Backend healthy!"
            break
          else
            echo "‚è≥ Waiting for backend health... ($i/10, status=$STATUS)"
            sleep 3
          fi
        done

        echo "üßπ Ê∏ÖÁêÜÊóßÂÆπÂô®ÂíåËµÑÊ∫ê..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "docker system prune -f --volumes --filter 'until=24h'" && \
          echo "‚úÖ Docker cleanup completed!" || echo "‚ö†Ô∏è Docker prune failed"


    - name: Notify Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Production deployment completed"
        else
          echo "‚ùå Deployment failed!"
        fi