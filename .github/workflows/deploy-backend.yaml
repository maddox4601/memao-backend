name: Deploy Flask Backend (Master)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 25
    env:
      FLASK_APP: "app.py"
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: master
        fetch-depth: 0

    - name: Validate Migrations
      run: |
        if [ -n "$(git status -s alembic/versions/)" ]; then
          echo "::error::Uncommitted migration files detected:"
          git status alembic/versions/
          exit 1
        fi

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: Deploy via SSH
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      run: |
        # 检查本地 secret 是否可用
        if [ -z "$GOOGLE_CLIENT_ID" ]; then
          echo "::error::GOOGLE_CLIENT_ID is empty"
        else
          echo "✅ GOOGLE_CLIENT_ID is set (masked)"
        fi
        if [ -z "$GOOGLE_CLIENT_SECRET" ]; then
          echo "::error::GOOGLE_CLIENT_SECRET is empty"
        else
          echo "✅ GOOGLE_CLIENT_SECRET is set (masked)"
        fi
        
        # 更新 .env.pro
        sed -i '/GOOGLE_CLIENT_/d' .env.pro
        echo "" >> .env.pro
        echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env.pro
        echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env.pro

        # 通过 ssh 传递环境变量到远程 shell
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} 'bash -s' < deploy.sh     

    - name: Notify Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Production deployment completed"
        else
          echo "❌ Deployment failed!"
        fi