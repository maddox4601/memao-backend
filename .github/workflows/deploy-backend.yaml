name: Deploy Flask Backend (Master)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      FLASK_APP: "app.py"
      DB_RETRY_TIMEOUT: 30  # æ•°æ®åº“ç­‰å¾…è¶…æ—¶(ç§’)

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: master
        fetch-depth: 0

    - name: Validate Migrations
      run: |
        # æ£€æŸ¥æœªæäº¤çš„è¿ç§»æ–‡ä»¶
        if [ -n "$(git status -s alembic/versions/)" ]; then
          echo "::error::å­˜åœ¨æœªæäº¤çš„è¿ç§»æ–‡ä»¶:"
          git status alembic/versions/
          exit 1
        fi

        # æ£€æŸ¥è¿ç§»æ–‡ä»¶å†²çª
        if [ $(flask db heads | wc -l) -gt 1 ]; then
          echo "::error::å­˜åœ¨å¤šä¸ªè¿ç§»HEADç‰ˆæœ¬:"
          flask db heads
          exit 1
        fi

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: Deploy via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
        set -eo pipefail
        echo "â–¶ï¸ [Master] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¯åŠ¨..."
        
        # ç¯å¢ƒé…ç½®
        export DEPLOY_DIR="/root/memao-backend"
        export TIMESTAMP=$(date +%Y%m%d%H%M%S)
        export LOG_FILE="/tmp/deploy_${TIMESTAMP}.log"
        export DB_BACKUP_FILE="/backups/db_pre_deploy_${TIMESTAMP}.sql"
        
        # æ—¥å¿—è®°å½•
        exec > >(tee -a "$LOG_FILE") 2>&1

        # 0. æ•°æ®åº“å¤‡ä»½
        echo "ğŸ’¾ æ•°æ®åº“å¤‡ä»½..."
        docker compose exec -T db \
          mysqldump -u${{ secrets.DB_USER }} -p"${{ secrets.DB_PASSWORD }}" ${{ secrets.DB_NAME }} > "$DB_BACKUP_FILE" || {
          echo "::warning::æ•°æ®åº“å¤‡ä»½å¤±è´¥ï¼ˆç»§ç»­éƒ¨ç½²ï¼‰"
        }

        # 1. ä»£ç åŒæ­¥
        cd "$DEPLOY_DIR" || exit 1
        echo "ğŸ”„ åŒæ­¥ä»£ç ..."
        git fetch --tags origin master
        git checkout -B master origin/master
        git reset --hard origin/master

        # 2. æ£€æµ‹è¿ç§»å˜æ›´
        MIGRATION_CHANGED=$(git diff --name-only HEAD@{1} HEAD | grep -q "alembic/versions/" && echo true || echo false)
        echo "ğŸ” è¿ç§»æ–‡ä»¶å˜æ›´: $MIGRATION_CHANGED"

        # 3. æœåŠ¡é‡å»º
        echo "ğŸ³ é‡å»ºDockeræœåŠ¡..."
        docker compose down --timeout 30
        docker compose up -d --build

        # 4. å®¹å™¨å¥åº·æ£€æŸ¥ï¼ˆå¸¦é‡è¯•ï¼‰
        echo "ğŸ©º ç­‰å¾…æœåŠ¡å°±ç»ª..."
        for i in $(seq 1 6); do
          if docker compose ps | grep -q "(healthy)"; then
            break
          fi
          [ $i -eq 6 ] && {
            echo "::error::å®¹å™¨å¯åŠ¨è¶…æ—¶"
            docker compose logs
            exit 1
          }
          sleep 5
          echo "å°è¯• $i/6..."
        done

        # 5. æ•°æ®åº“è¿ç§»ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰
        if $MIGRATION_CHANGED; then
          echo "ğŸ—ƒï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
          docker compose exec -T backend bash -c "
            set -eo pipefail
            export PYTHONPATH=/app
            
            # ç­‰å¾…æ•°æ®åº“å°±ç»ª
            for i in \$(seq 1 $DB_RETRY_TIMEOUT); do
              if flask db current &>/dev/null; then
                break
              fi
              [ \$i -eq $DB_RETRY_TIMEOUT ] && {
                echo '::error::æ•°æ®åº“è¿æ¥è¶…æ—¶'
                exit 1
              }
              sleep 1
            done

            echo '=== è¿ç§»å‰ç‰ˆæœ¬ ==='
            flask db current || true
            
            echo '=== æ‰§è¡Œè¿ç§» ==='
            if ! flask db upgrade 2>&1; then
              echo '::error::è¿ç§»æ‰§è¡Œå¤±è´¥ï¼Œå°è¯•å›æ»š...'
              flask db downgrade -1
              exit 1
            fi
            
            echo '=== è¿ç§»åç‰ˆæœ¬ ==='
            flask db current
          " | tee "/tmp/db_migration_${TIMESTAMP}.log"
        else
          echo "â© è·³è¿‡æ•°æ®åº“è¿ç§»ï¼ˆæ— å˜æ›´ï¼‰"
        fi

        # 6. æœ€ç»ˆéªŒè¯
        echo "âœ… éªŒè¯éƒ¨ç½²..."
        if ! docker compose exec -T backend curl -s http://localhost/health | grep -q "healthy"; then
          echo "::error::å¥åº·æ£€æŸ¥å¤±è´¥"
          docker compose logs --tail=50
          exit 1
        fi

        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆ"
        echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
        echo "æ•°æ®åº“å¤‡ä»½: $DB_BACKUP_FILE"
        EOF

    - name: Post-Deploy Notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
          # å¯æ·»åŠ æˆåŠŸé€šçŸ¥ï¼ˆå¦‚Slack/é‚®ä»¶ï¼‰
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼éœ€è¦äººå·¥å¹²é¢„"
          # å¯æ·»åŠ å‘Šè­¦é€šçŸ¥
        fi