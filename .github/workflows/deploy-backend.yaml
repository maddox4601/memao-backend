name: Deploy Flask Backend (Master)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: master
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

    - name: Verify Migrations
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„è¿ç§»æ–‡ä»¶
        if git status -s alembic/versions/ | grep -q "^ M"; then
          echo "::error::å­˜åœ¨æœªæäº¤çš„æ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼"
          git status alembic/versions/
          exit 1
        fi

        # æ£€æŸ¥æœ¬æ¬¡æäº¤æ˜¯å¦åŒ…å«è¿ç§»æ–‡ä»¶
        if [ "$(git diff --name-only origin/master...HEAD | grep -c 'alembic/versions/')" -eq 0 ]; then
          echo "::notice::æœ¬æ¬¡æäº¤æœªåŒ…å«æ•°æ®åº“è¿ç§»æ–‡ä»¶"
        fi

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: Verify SSH Connection
      run: |
        ssh -T -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} exit
        if [ $? -ne 0 ]; then
          echo "::error::SSHè¿æ¥æµ‹è¯•å¤±è´¥"
          exit 1
        fi

    - name: Deploy via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
        set -e
        echo "â–¶ï¸ [Master] å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
        
        # ç¯å¢ƒå˜é‡é…ç½®
        export DEPLOY_DIR="/root/memao-backend"
        export LOG_FILE="/tmp/deploy_$(date +%Y%m%d%H%M%S).log"
        
        # è®°å½•è¯¦ç»†æ—¥å¿—
        exec > >(tee -a "$LOG_FILE") 2>&1

        # éªŒè¯éƒ¨ç½²ç›®å½•
        if [ ! -d "$DEPLOY_DIR" ]; then
          echo "::error::éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: $DEPLOY_DIR"
          exit 1
        fi

        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd "$DEPLOY_DIR" || exit 1
        
        # æ‹‰å–æœ€æ–°ä»£ç 
        echo "ğŸ”„ åŒæ­¥masteråˆ†æ”¯..."
        git fetch origin master
        git checkout master
        git reset --hard origin/master || {
          echo "::error::GitåŒæ­¥å¤±è´¥"
          exit 1
        }

        # æ£€æŸ¥æ–‡ä»¶å˜åŒ–
        echo "ğŸ“„ æ–‡ä»¶å˜æ›´æ£€æŸ¥:"
        git diff --name-only HEAD@{1} HEAD

        # é‡å»ºå®¹å™¨
        echo "ğŸ³ é‡å»ºDockeræœåŠ¡..."
        docker compose down --timeout 30 || true
        
        if ! docker compose up -d --build; then
          echo "::error::Dockeréƒ¨ç½²å¤±è´¥"
          docker compose logs --tail=50
          exit 1
        fi
        
        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨(10ç§’)..."
        sleep 10

        # æ•°æ®åº“è¿ç§»ï¼ˆæ–°ç‰ˆä¼˜åŒ–æµç¨‹ï¼‰
        echo "ğŸ—ƒï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
        DB_MIGRATION_LOG="/tmp/db_migration_$(date +%s).log"
        docker compose exec -T backend bash -c "
          set -e
          export FLASK_APP=app.py
          export PYTHONPATH=/app
          
          echo '=== å½“å‰æ•°æ®åº“ç‰ˆæœ¬ ==='
          flask db current || true
          
          echo '=== æ ‡è®°å½“å‰ç‰ˆæœ¬ ==='
          flask db stamp head 2>&1
          
          echo '=== æ‰§è¡Œè¿ç§» ==='
          flask db upgrade 2>&1
          
          echo '=== è¿ç§»åç‰ˆæœ¬ ==='
          flask db current
        " | tee "$DB_MIGRATION_LOG"
        
        # æ£€æŸ¥è¿ç§»æ˜¯å¦æˆåŠŸ
        if grep -q "ERROR" "$DB_MIGRATION_LOG"; then
          echo "::error::æ•°æ®åº“è¿ç§»å¤±è´¥"
          cat "$DB_MIGRATION_LOG"
          exit 1
        fi

        # å¥åº·æ£€æŸ¥
        echo "ğŸ©º æœåŠ¡å¥åº·æ£€æŸ¥..."
        sleep 15
        if ! docker ps --filter "name=memao-backend" --format "table {{.Names}}\t{{.Status}}" | grep "(healthy)"; then
          echo "::warning::å®¹å™¨æœªæ˜¾ç¤ºhealthyçŠ¶æ€"
          docker compose logs --tail=50
          # éå…³é”®é”™è¯¯ä¸ç»ˆæ­¢æµç¨‹
        fi

        echo "âœ… [Master] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
        echo "è¯¦ç»†æ—¥å¿—è§: $LOG_FILE"
        EOF

    - name: Notify Success
      if: success()
      run: |
        echo "éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
        # å¯æ·»åŠ é€šçŸ¥é€»è¾‘ï¼ˆå¦‚Slack/é‚®ä»¶ï¼‰