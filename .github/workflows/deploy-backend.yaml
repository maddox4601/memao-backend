- name: Deploy via SSH
  env:
    GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
    GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
  run: |
    # æ£€æŸ¥ secrets
    if [ -z "${{ secrets.GOOGLE_CLIENT_ID }}" ]; then
      echo "::error::GOOGLE_CLIENT_ID is empty or not accessible"
    else
      echo "âœ… GOOGLE_CLIENT_ID is set (masked for security)"
    fi
    if [ -z "${{ secrets.GOOGLE_CLIENT_SECRET }}" ]; then
      echo "::error::GOOGLE_CLIENT_SECRET is empty or not accessible"
    else
      echo "âœ… GOOGLE_CLIENT_SECRET is set (masked for security)"
    fi

    ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
    set -eo pipefail
    echo "ğŸš€ Starting production deployment..."

    DEPLOY_DIR="/root/memao-backend"
    TIMESTAMP=\$(date +%Y%m%d%H%M%S)
    LOG_FILE="/tmp/deploy_\${TIMESTAMP}.log"
    exec > >(tee -a "\$LOG_FILE") 2>&1

    # 1ï¸âƒ£ clone æˆ–æ›´æ–°ä»“åº“
    if [ ! -d "\$DEPLOY_DIR/.git" ]; then
      echo "Cloning repository..."
      git clone https://github.com/maddox4601/memao-backend.git "\$DEPLOY_DIR"
    fi
    cd "\$DEPLOY_DIR" || exit 1
    echo "ğŸ” Syncing code..."
    git fetch --tags origin master
    git reset --hard
    git clean -fd
    git checkout -B master origin/master
    git reset --hard origin/master

    # 2ï¸âƒ£ æ›´æ–° .env.pro
    echo "ğŸ”‘ Updating environment file..."
    ENV_FILE="\$DEPLOY_DIR/.env.pro"
    grep -v "GOOGLE_CLIENT_" "\$ENV_FILE" > "\$ENV_FILE.tmp" || true
    echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> "\$ENV_FILE.tmp"
    echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> "\$ENV_FILE.tmp"
    mv "\$ENV_FILE.tmp" "\$ENV_FILE"

    # 3ï¸âƒ£ é‡å»º Docker å®¹å™¨
    echo "ğŸ³ Rebuilding containers..."
    docker compose --env-file "\$ENV_FILE" down --timeout 30
    docker compose --env-file "\$ENV_FILE" up -d --build

    # 4ï¸âƒ£ ç­‰å¾… MySQL å¥åº·
    echo "â³ Waiting for MySQL to be healthy..."
    DB_WAIT_TIMEOUT=120
    DB_READY=false
    for i in \$(seq 1 \$DB_WAIT_TIMEOUT); do
      if docker compose ps mysql | grep -q "healthy"; then
        DB_READY=true
        break
      fi
      sleep 2
      echo "Waiting...(\$i/\$DB_WAIT_TIMEOUT)"
    done
    if ! \$DB_READY; then
      echo "::error::MySQL startup timed out"
      docker compose logs mysql
      exit 1
    fi

    # 5ï¸âƒ£ æ•°æ®åº“è¿ç§»
    echo "ğŸ› ï¸ Executing database migration..."
    docker compose --env-file "\$ENV_FILE" exec -T backend bash -c "
      set -eo pipefail
      export PYTHONPATH=/app
      echo 'Checking database connection...'
      for i in \$(seq 1 30); do
        if flask db current &>/dev/null; then
          echo 'DB connected âœ…'
          break
        fi
        if [ \$i -eq 30 ]; then
          echo '::error::Failed to connect to database via flask'
          exit 1
        fi
        sleep 2
      done
      echo '=== Current DB Revision ==='
      flask db current || echo 'No current revision (fresh database?)'
      echo '=== Executing Migration ==='
      if flask db upgrade 2>&1; then
        echo '=== Migration Complete ==='
        flask db current
      else
        echo '::error::Migration failed'
        flask db current || true
        exit 1
      fi
    " | tee "/tmp/migration_\${TIMESTAMP}.log"

    # 6ï¸âƒ£ æœ€ç»ˆå¥åº·æ£€æŸ¥
    echo "âœ… Verifying deployment..."
    for i in {1..10}; do
      if docker compose exec -T backend curl -sf http://localhost:5000/health > /dev/null; then
        echo "Health check passed âœ…"
        break
      fi
      if [ \$i -eq 10 ]; then
        echo "::error::Health check failed after 10 attempts"
        docker compose logs --tail=50 backend
        exit 1
      fi
      sleep 3
    done

    echo "ğŸ‰ Deployment successful!"
    echo "Logs: \$LOG_FILE"

    # 7ï¸âƒ£ æ¸…ç†æ—§å®¹å™¨å’Œé•œåƒ
    echo "ğŸ§¹ Cleaning up..."
    docker system prune -f --filter "until=24h"
    EOF
